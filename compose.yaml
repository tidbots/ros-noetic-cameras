services:
  # --------------------------
  # ROS Master
  # --------------------------
  roscore:
    image: ros-noetic-cameras:latest
    build: .
    network_mode: host
    restart: unless-stopped
    command: ["bash","-lc","source /opt/ros/noetic/setup.bash && roscore"]

  # ==========================
  # Camera sources (pick ONE)
  # ==========================

  # --------------------------
  # USB Webカメラ (UVC)
  # --------------------------
  camera_webcam:
    image: ros-noetic-cameras:latest
    depends_on: [roscore]
    network_mode: host
    ipc: host
    restart: unless-stopped
    devices:
      - ${CAM_DEV:-/dev/video0}:${CAM_DEV:-/dev/video0}
    environment:
      - ROS_MASTER_URI=http://127.0.0.1:11311
      - ROS_IP=127.0.0.1
    volumes:
      # launchをホストから差し替え（再ビルド不要）
      - ./launch:/launch:ro
      # camera_info 永続化（Webカメラ用）
      - ./persist/camera_info/webcam:/root/.ros/camera_info
    command:
      [
        "bash","-lc",
        "source /opt/ros/noetic/setup.bash &&          roslaunch --wait /launch/webcam.launch            device:=${CAM_DEV:-/dev/video0}            width:=${CAM_W:-1280} height:=${CAM_H:-720} fps:=${CAM_FPS:-30}            frame_id:=${CAM_FRAME:-webcam_link}            camera_name:=${CAMERA_NAME:-webcam}            camera_info_url:=${CAMERA_INFO_URL:-file:///root/.ros/camera_info/webcam.yaml}            out_image:=${OUT_IMAGE:-/camera/image_raw}            out_info:=${OUT_INFO:-/camera/camera_info}"
      ]
    profiles: ["webcam"]

  # --------------------------
  # ASUS Xtion / OpenNI2 (RGB-D)
  # --------------------------
  camera_xtion:
    image: ros-noetic-cameras:latest
    depends_on: [roscore]
    network_mode: host
    ipc: host
    restart: unless-stopped
    # XtionはUSBデバイスのパーミッション問題が出ることが多いので、
    # まずはprivilegedで動かし、必要に応じて絞ってください。
    privileged: true
    environment:
      - ROS_MASTER_URI=http://127.0.0.1:11311
      - ROS_IP=127.0.0.1
    volumes:
      - ./launch:/launch:ro
      # camera_info 永続化（Xtion用）
      - ./persist/camera_info/xtion:/root/.ros/camera_info
    command:
      [
        "bash","-lc",
        "source /opt/ros/noetic/setup.bash &&          roslaunch --wait /launch/xtion.launch            name:=${XTION_NAME:-xtion}            camera:=${XTION_CAMERA_NS:-camera}            rgb_camera_info_url:=${XTION_RGB_INFO_URL:-file:///root/.ros/camera_info/xtion_rgb.yaml}            depth_camera_info_url:=${XTION_DEPTH_INFO_URL:-file:///root/.ros/camera_info/xtion_depth.yaml}            in_image:=${XTION_IN_IMAGE:-/xtion/camera/rgb/image_raw}            in_info:=${XTION_IN_INFO:-/xtion/camera/rgb/camera_info}            out_image:=${OUT_IMAGE:-/camera/image_raw}            out_info:=${OUT_INFO:-/camera/camera_info}"
      ]
    profiles: ["xtion"]

  # --------------------------
  # Intel RealSense (realsense2_camera)
  # --------------------------
  camera_realsense:
    image: ros-noetic-cameras:latest
    depends_on: [roscore]
    network_mode: host
    ipc: host
    restart: unless-stopped
    privileged: true
    environment:
      - ROS_MASTER_URI=http://127.0.0.1:11311
      - ROS_IP=127.0.0.1
    volumes:
      - ./launch:/launch:ro
      # camera_info 永続化（RealSense用：主に自前yamlを置く用途）
      - ./persist/camera_info/realsense:/root/.ros/camera_info
    command:
      [
        "bash","-lc",
        "source /opt/ros/noetic/setup.bash &&          roslaunch --wait /launch/realsense.launch            name:=${RS_NAME:-realsense}            in_image:=${RS_IN_IMAGE:-/realsense/color/image_raw}            in_info:=${RS_IN_INFO:-/realsense/color/camera_info}            out_image:=${OUT_IMAGE:-/camera/image_raw}            out_info:=${OUT_INFO:-/camera/camera_info}"
      ]
    profiles: ["realsense"]

  # ==========================
  # Debug utilities
  # ==========================

  # ブラウザで確認（http://localhost:8080/ など）
  web_video_server:
    image: ros-noetic-cameras:latest
    depends_on: [roscore]
    network_mode: host
    restart: unless-stopped
    environment:
      - ROS_MASTER_URI=http://127.0.0.1:11311
      - ROS_IP=127.0.0.1
    volumes:
      - ./launch:/launch:ro
    command:
      ["bash","-lc","source /opt/ros/noetic/setup.bash && roslaunch --wait /launch/web_video_server.launch port:=${WVS_PORT:-8080}"]
    profiles: ["debug"]

  rqt_image_view:
    image: ros-noetic-cameras:latest
    depends_on: [roscore]
    network_mode: host
    restart: "no"
    environment:
      - ROS_MASTER_URI=http://127.0.0.1:11311
      - ROS_IP=127.0.0.1
      - DISPLAY=${DISPLAY}
      - QT_X11_NO_MITSHM=1
      - XAUTHORITY=/root/.Xauthority
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - ${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro
      - ./launch:/launch:ro
    command:
      [
    "bash","-lc",
    "source /opt/ros/noetic/setup.bash && \
     rosrun rqt_image_view rqt_image_view --force-discover --clear-config /camera/image_raw"
      ]
    profiles: ["image"]

  # X11で画像ウィンドウ表示（DISPLAYやXauthorityが整っているときだけ）
  image_view_rgb:
    image: ros-noetic-cameras:latest
    depends_on: [roscore]
    network_mode: host
    restart: "no"
    environment:
      - ROS_MASTER_URI=http://127.0.0.1:11311
      - ROS_IP=127.0.0.1
      - DISPLAY=${DISPLAY}
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - ${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro
      - ./launch:/launch:ro
    command:
      ["bash","-lc","export XAUTHORITY=/root/.Xauthority; source /opt/ros/noetic/setup.bash && roslaunch --wait /launch/image_view_rgb.launch image:=${OUT_IMAGE:-/camera/image_raw}"]
    profiles: ["x11"]

